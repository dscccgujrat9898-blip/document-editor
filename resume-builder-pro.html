<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DS Resume Builder PRO (A4 Print + PDF Fixed)</title>

<style>
  :root{
    --ui-bg:#0b1220; --ui-card:#0f1b34; --ui-txt:#e9f0ff; --ui-muted:#a9b7d0;
    --ui-shadow:0 14px 40px rgba(0,0,0,.35); --ui-r:18px;

    --accent:#2563eb; --accent2:#7c3aed;
    --ink:#0b1220; --muted:#4b5563;
    --paper:#ffffff; --soft:#f3f4f6;
    --line:#e5e7eb;
  }

  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:radial-gradient(1200px 650px at 18% 0%,#162b55 0%,#0b1220 55%,#070b14 100%);color:var(--ui-txt)}
  header{
    position:sticky;top:0;z-index:50;
    backdrop-filter: blur(10px);
    background: rgba(11,18,32,.78);
    border-bottom:1px solid rgba(255,255,255,.08);
    padding:14px 18px;
    display:flex;align-items:center;gap:12px;justify-content:space-between;
  }
  header .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:38px;height:38px;border-radius:12px;
    background:linear-gradient(135deg,#2b5cff,#7c3aed);
    display:grid;place-items:center;font-weight:900;
    box-shadow:0 12px 30px rgba(43,92,255,.25);
  }
  header h1{font-size:16px;margin:0}
  header .sub{font-size:12px;color:var(--ui-muted);margin-top:2px}
  .top-actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
  .btn{
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:var(--ui-txt); padding:9px 12px;border-radius:14px;
    cursor:pointer; font-weight:650; font-size:13px;
    transition:.15s transform,.15s background,.15s border;
  }
  .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.22)}
  .btn.primary{background:linear-gradient(135deg,#2b5cff,#7c3aed);border:none}
  .btn.good{background:linear-gradient(135deg,#22c55e,#16a34a);border:none}
  .btn.danger{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35)}
  .wrap{padding:18px}
  .grid{display:grid;grid-template-columns: 460px 1fr; gap:16px; align-items:start}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.10);
    border-radius:var(--ui-r);
    box-shadow:var(--ui-shadow);
    overflow:hidden;
  }
  .card .hd{
    padding:14px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:center;justify-content:space-between;gap:10px
  }
  .card .hd strong{font-size:14px}
  .card .bd{padding:14px}

  .row{display:grid;grid-template-columns:1fr 1fr; gap:10px}
  @media(max-width:980px){.row{grid-template-columns:1fr}}
  label{display:block;font-size:12px;color:var(--ui-muted);margin:2px 0 6px}
  input, textarea, select{
    width:100%; padding:10px 10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(7,11,20,.55);
    color:var(--ui-txt);
    outline:none;
  }
  textarea{min-height:92px;resize:vertical}
  .hint{font-size:12px;color:var(--ui-muted);margin-top:6px;line-height:1.35}
  .sep{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);font-size:12px;color:var(--ui-txt)}
  .switch{display:flex;align-items:center;gap:10px;margin-top:6px}
  .switch input{width:auto}

  .preview-wrap{background:#f3f4f6;padding:18px}
  .pages{display:flex;flex-direction:column;gap:14px;align-items:center}

  /* Preview A4 page */
  .page{
    width:210mm;
    height:297mm;
    min-height:297mm;
    background:var(--paper);
    color:var(--ink);
    border-radius:14px;
    box-shadow:0 18px 50px rgba(0,0,0,.25);
    overflow:hidden;
    position:relative;
  }
  .page .inner{
    padding:16mm 14mm 14mm 14mm;
    height:297mm;
    overflow:hidden;
  }
  .watermark{
    position:absolute; inset:auto 12mm 10mm auto;
    font-size:10px; color:#9ca3af;
  }

  .r-name{font-size:28px;font-weight:900;line-height:1.1;margin:0}
  .r-role{font-size:13.5px;color:var(--muted);margin-top:6px}
  .r-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .r-chip{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--soft);border:1px solid var(--line)}
  .r-sec{margin-top:12px}
  .r-sec p{margin:0;color:var(--ink);font-size:13px;line-height:1.6}
  .r-item{margin:10px 0}
  .r-item .head{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
  .r-item .head strong{font-size:13.4px}
  .r-ul{margin:8px 0 0 18px;padding:0}
  .r-ul li{margin:5px 0;font-size:13px;line-height:1.55}
  .r-skillwrap{display:flex;flex-wrap:wrap;gap:8px}
  .r-skill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}

  .avatar{width:86px;height:86px;border-radius:999px;background:#e5e7eb;overflow:hidden;flex:0 0 auto;border:3px solid #fff;box-shadow:0 10px 25px rgba(0,0,0,.15)}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .hdr-row{display:flex;gap:14px;align-items:center}

  .hdr{padding:12px 12px;border-radius:12px}
  .hdr.classic{border:1px solid var(--line);background:#fff}
  .hdr.line{border:1px solid var(--line);background:#fff;border-left:6px solid var(--accent)}
  .hdr.dark{background:#111827;color:#fff;border:0}
  .hdr.dark .r-role{color:#cbd5e1}
  .hdr.dark .r-chip{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.16);color:#fff}
  .hdr.grad{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:0}
  .hdr.grad .r-role{color:rgba(255,255,255,.86)}
  .hdr.grad .r-chip{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);color:#fff}

  /* Decoration */
  .page::before{content:"";position:absolute;inset:0;pointer-events:none}
  .page[data-deco="none"]::before{display:none}
  .page[data-deco="corner"]::before{
    background:
      radial-gradient(200px 200px at 0% 0%, rgba(0,0,0,.04), transparent 60%),
      radial-gradient(240px 240px at 100% 0%, rgba(0,0,0,.03), transparent 60%);
  }
  .page[data-deco="accentbar"]::before{
    background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 18%, transparent) 0 7mm, transparent 7mm 100%);
  }

  /* CV look */
  .cv-titlebar{
    margin-bottom:10mm;
    text-align:center;
    font-family: "Times New Roman", Georgia, serif;
    letter-spacing:.02em;
    font-weight:800;
    font-size:26px;
    padding:8mm 6mm;
    border:1px solid #c9c9c9;
    background:#d6cfb3;
  }
  .secbar{
    margin-top:12px;
    border:1px solid #bdbdbd;
    background:#d6d6d6;
    padding:5px 8px;
    font-family:"Times New Roman", Georgia, serif;
    font-weight:800;
    letter-spacing:.02em;
  }
  .cv p,.cv li,.cv .r-item strong{font-family:"Times New Roman", Georgia, serif}
  .cv .hdr{border-radius:0}

  .modern .r-sec h3{
    margin:0 0 8px;font-size:12.2px;letter-spacing:.12em;text-transform:uppercase;color:var(--ink);
    position:relative;padding-bottom:6px;
  }
  .modern .r-sec h3::after{
    content:"";position:absolute;left:0;bottom:0;width:44px;height:3px;background:var(--accent);border-radius:99px;opacity:.85;
  }

  /* Print A4 */
  @page{ size:A4; margin:0; }

  @media print{
    header,.form-card,.tips{display:none !important}
    body,.preview-wrap{background:#fff !important}
    .wrap{padding:0 !important}
    #pages,.pages{display:block !important}

    /* SAFE print area (avoids extra blank pages even if user keeps default margins) */
    .page{
      width:190mm !important;
      height:277mm !important;
      min-height:277mm !important;
      margin:0 auto !important;

      border-radius:0 !important;
      box-shadow:none !important;
      overflow:hidden !important;

      page-break-after:always !important;
      break-after:page !important;
    }
    #pages .page:last-of-type{
      page-break-after:auto !important;
      break-after:auto !important;
    }
    .page[style*="display: none"]{display:none !important}
  }

  body.pdf-mode{background:#fff !important}
  body.pdf-mode header,
  body.pdf-mode .form-card,
  body.pdf-mode .tips{display:none !important}
  body.pdf-mode .wrap{padding:0 !important}
  body.pdf-mode .preview-wrap{padding:0 !important;background:#fff !important}
  body.pdf-mode .page{
    width:210mm !important;
    height:297mm !important;
    min-height:297mm !important;
    border-radius:0 !important;
    box-shadow:none !important;
  }
</style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">DS</div>
    <div>
      <h1>DS Resume Builder PRO</h1>
      <div class="sub">A4 Print Fixed â€¢ PDF Download Fixed â€¢ Manual Address Only</div>
    </div>
  </div>
  <div class="top-actions">
    <button class="btn" id="btnLoad">Load Saved</button>
    <button class="btn" id="btnSave">Save</button>
    <button class="btn danger" id="btnReset">Reset</button>
    <button class="btn" id="btnPrint">Print</button>
    <button class="btn good" id="btnPDF">Download PDF</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Form -->
    <div class="card form-card">
      <div class="hd">
        <strong>Resume Details</strong>
        <span class="pill">Auto-save ON</span>
      </div>
      <div class="bd">

        <div class="row">
          <div>
            <label>Template</label>
            <select id="template"></select>
            <div class="hint">CV templates look like traditional resumes. ATS Mode makes it clean.</div>
          </div>
          <div>
            <label>Color Theme</label>
            <select id="theme"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Custom Primary Accent (optional)</label>
            <input id="customAccent" placeholder="#2563eb"/>
          </div>
          <div>
            <label>Custom Secondary Accent (optional)</label>
            <input id="customAccent2" placeholder="#7c3aed"/>
          </div>
        </div>

        <div class="sep"></div>

        <div class="switch">
          <input type="checkbox" id="atsMode"/>
          <label style="margin:0">ATS Mode (simple, clean resume)</label>
        </div>
        <div class="hint">ATS Mode disables decorations and keeps resume clean for job portals.</div>

        <div class="row">
          <div>
            <label>Photo</label>
            <div class="switch">
              <input type="checkbox" id="photoEnabled" checked/>
              <label style="margin:0">Photo ON/OFF</label>
            </div>
            <input id="photo" type="file" accept="image/*"/>
          </div>
          <div>
            <label>Brand watermark</label>
            <input id="brand" placeholder="DS Computer Classes"/>
            <div class="hint">Small watermark on print/PDF.</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="switch">
          <input type="checkbox" id="enablePage2" checked/>
          <label style="margin:0">Enable Page 2</label>
        </div>
        <div class="hint">If content overflows, Page 2 auto activates and nothing will be cut.</div>

        <div class="sep"></div>

        <div class="row">
          <div>
            <label>Full Name</label>
            <input id="name" placeholder="e.g., Rahul Patel"/>
          </div>
          <div>
            <label>Father's Name</label>
            <input id="fatherName" placeholder="e.g., Mahesh Patel"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Professional Title</label>
            <input id="role" placeholder="e.g., Accountant / Data Entry / Designer"/>
          </div>
          <div>
            <label>Phone</label>
            <input id="phone" placeholder="e.g., 98987xxxxx"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Email</label>
            <input id="email" placeholder="e.g., name@gmail.com"/>
          </div>
          <div>
            <label>Links (optional)</label>
            <input id="links" placeholder="LinkedIn / Portfolio / GitHub (comma separated)"/>
          </div>
        </div>

        <div class="sep"></div>

        <label>Objective Templates</label>
        <select id="objectiveTpl"></select>
        <div class="hint">Selecting an objective will auto-fill the Objective box (you can edit it).</div>

        <label>Career Objective</label>
        <textarea id="summary" placeholder="Write a short objective here."></textarea>

        <div class="sep"></div>

        <label>Skills (comma separated)</label>
        <input id="skills" placeholder="Tally, Excel, Photoshop, Java, Communication..."/>

        <div class="sep"></div>

        <label>Education (one per line)</label>
        <textarea id="education" placeholder="BCA (2024â€“2027) â€“ XYZ College, Surat&#10;12th (2023) â€“ GSEB"></textarea>

        <div class="sep"></div>

        <div class="switch">
          <input type="checkbox" id="toggleExp" checked/>
          <label style="margin:0">Show Experience</label>
        </div>
        <textarea id="experience" placeholder="Format:
Job â€“ Company (Year)
- bullet
- bullet

(Blank line = new job)"></textarea>

        <div class="sep"></div>

        <div class="switch">
          <input type="checkbox" id="toggleProj" checked/>
          <label style="margin:0">Show Projects</label>
        </div>
        <textarea id="projects" placeholder="Project Title
- bullet
- bullet

(Blank line = new project)"></textarea>

        <div class="sep"></div>

        <div class="switch">
          <input type="checkbox" id="toggleCert" checked/>
          <label style="margin:0">Show Certifications</label>
        </div>
        <textarea id="certs" placeholder="Certification â€“ Institute (Year)"></textarea>

        <div class="sep"></div>

        <label>Languages (comma separated)</label>
        <input id="langs" placeholder="Hindi, English, Gujarati"/>

        <label>Interests (comma separated)</label>
        <input id="hobbies" placeholder="Teaching, Designing, Computers"/>

        <div class="sep"></div>

        <strong style="display:block;margin:0 0 8px">Address (Manual Only)</strong>

        <div class="switch">
          <input type="checkbox" id="sameAddress"/>
          <label style="margin:0">Permanent address same as Temporary</label>
        </div>

        <div class="sep"></div>

        <div style="font-weight:700;font-size:12px;color:var(--ui-muted);margin-bottom:6px">Temporary Address</div>
        <textarea id="tempAddress" placeholder="House No, Street, Area, Police Station, District, State, Pincode"></textarea>

        <div class="sep"></div>

        <div style="font-weight:700;font-size:12px;color:var(--ui-muted);margin-bottom:6px">Permanent Address</div>
        <textarea id="permAddress" placeholder="House No, Street, Area, Police Station, District, State, Pincode"></textarea>

      </div>
    </div>

    <!-- Preview -->
    <div class="card">
      <div class="hd">
        <strong>Live Preview</strong>
        <span class="pill">A4 â€¢ Fixed</span>
      </div>

      <div class="preview-wrap">
        <div class="pages" id="pages"></div>
        <div class="tips" style="max-width:860px;margin:12px auto 0;color:#0b1220;opacity:.75;font-size:12px">
          Print Tip: Choose A4 in print dialog. If user selects Letter, print will still fit but may scale.
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const KEY = "ds_resume_builder_manual_address_v1";

  const THEMES = {
    blue:{label:"Blue",a:"#2563eb",b:"#7c3aed"},
    green:{label:"Green",a:"#16a34a",b:"#0ea5e9"},
    purple:{label:"Purple",a:"#7c3aed",b:"#2563eb"},
    orange:{label:"Orange",a:"#f97316",b:"#eab308"},
    red:{label:"Red",a:"#ef4444",b:"#f97316"},
    teal:{label:"Teal",a:"#14b8a6",b:"#0ea5e9"},
    navy:{label:"Navy",a:"#1d4ed8",b:"#0f172a"},
    pink:{label:"Pink",a:"#ec4899",b:"#8b5cf6"},
    slate:{label:"Slate",a:"#334155",b:"#64748b"},
    gold:{label:"Gold",a:"#b45309",b:"#f59e0b"},
    custom:{label:"Custom (use below)",a:"",b:""}
  };

  const TEMPLATES = {
    t01:{name:"Modern Classic ATS",header:"classic",deco:"none",style:"modern"},
    t02:{name:"Modern Line Accent",header:"line",deco:"corner",style:"modern"},
    t03:{name:"Modern Dark Header",header:"dark",deco:"none",style:"modern"},
    t04:{name:"Modern Gradient Header",header:"grad",deco:"corner",style:"modern"},
    t05:{name:"CV Traditional (Beige Title)",header:"classic",deco:"none",style:"cv"},
  };

  const OBJECTIVES = [
    "To secure an entry-level role where I can apply strong learning ability, discipline, and communication skills to deliver quality work and grow with the organization.",
    "To work as a Computer Operator/Data Entry Executive utilizing fast typing, MS Office expertise, and attention to detail to maintain accurate records and support daily operations.",
    "To obtain an Accountant/Tally Executive position where I can apply Tally Prime, GST billing, voucher entries, and reconciliation skills to ensure compliance and accurate reporting.",
    "To join as a Graphic Designer where I can create high-impact creatives using Photoshop/CorelDRAW/Illustrator and contribute to branding and marketing growth.",
    "To work as a Textile/Digital Textile Designer where I can develop production-ready patterns and motifs with strong color sense and design software skills.",
    "To work as a Video Editor focusing on clean storytelling, smooth transitions, and social-media optimized edits using professional tools and best practices.",
    "To work as an IT Support/Office Assistant where I can troubleshoot issues, maintain documentation, and ensure smooth day-to-day operations.",
    "To start my career as a Java/BCA Fresher where I can apply programming fundamentals, problem-solving, and project experience to contribute to development tasks.",
    "To work as a Teacher/Trainer where I can explain concepts clearly, guide students practically, and help learners build job-ready skills.",
    "To join a growing company as an Office Executive where I can handle daily reporting, coordination, and documentation with accuracy."
  ];

  const state = {
    template:"t05",
    theme:"blue",
    customAccent:"",
    customAccent2:"",
    brand:"DS Computer Classes",

    enablePage2:true,

    atsMode:false,
    photoEnabled:true,
    photoDataUrl:"",

    name:"", fatherName:"",
    role:"", phone:"", email:"", links:"",

    summary:"",
    skills:"",
    education:"",
    experience:"",
    projects:"",
    certs:"",
    langs:"",
    hobbies:"",

    toggleExp:true,
    toggleProj:true,
    toggleCert:true,

    sameAddress:false,
    tempAddress:"",
    permAddress:""
  };

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function splitComma(s){ return (s||"").split(",").map(x=>x.trim()).filter(Boolean); }
  function lines(s){ return (s||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean); }

  function parseBlockToItems(text){
    const blocks = (text||"").split(/\n\s*\n/).map(b=>b.trim()).filter(Boolean);
    return blocks.map(b=>{
      const ls = b.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const head = ls[0] || "";
      const bullets = ls.slice(1).filter(x=>x.startsWith("-")).map(x=>x.replace(/^-+\s*/,""));
      const descLines = ls.slice(1).filter(x=>!x.startsWith("-"));
      return { head, bullets, descLines };
    });
  }

  function saveLocal(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function loadLocal(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return false;
    try{ Object.assign(state, JSON.parse(raw)); return true; }catch(e){ return false; }
  }

  function setSelectOptions(){
    const tSel = $("template");
    tSel.innerHTML = "";
    Object.entries(TEMPLATES).forEach(([k,v])=>{
      const opt = document.createElement("option");
      opt.value = k; opt.textContent = v.name;
      tSel.appendChild(opt);
    });

    const thSel = $("theme");
    thSel.innerHTML = "";
    Object.entries(THEMES).forEach(([k,v])=>{
      const opt = document.createElement("option");
      opt.value = k; opt.textContent = v.label;
      thSel.appendChild(opt);
    });

    const oSel = $("objectiveTpl");
    oSel.innerHTML = "";
    const first = document.createElement("option");
    first.value = ""; first.textContent = "-- Select Objective --";
    oSel.appendChild(first);
    OBJECTIVES.forEach((v, idx)=>{
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${String(idx+1).padStart(2,'0')}) ${v.slice(0, 70)}...`;
      oSel.appendChild(opt);
    });
  }

  function readFormToState(){
    state.template = $("template").value;
    state.theme = $("theme").value;
    state.customAccent = $("customAccent").value.trim();
    state.customAccent2 = $("customAccent2").value.trim();
    state.brand = $("brand").value.trim();

    state.enablePage2 = $("enablePage2").checked;

    state.atsMode = $("atsMode").checked;
    state.photoEnabled = $("photoEnabled").checked;

    if(state.atsMode){
      state.photoEnabled = false;
      $("photoEnabled").checked = false;
    }

    state.name = $("name").value.trim();
    state.fatherName = $("fatherName").value.trim();
    state.role = $("role").value.trim();
    state.phone = $("phone").value.trim();
    state.email = $("email").value.trim();
    state.links = $("links").value.trim();

    state.summary = $("summary").value.trim();

    state.skills = $("skills").value.trim();
    state.education = $("education").value.trim();
    state.experience = $("experience").value.trim();
    state.projects = $("projects").value.trim();
    state.certs = $("certs").value.trim();
    state.langs = $("langs").value.trim();
    state.hobbies = $("hobbies").value.trim();

    state.toggleExp = $("toggleExp").checked;
    state.toggleProj = $("toggleProj").checked;
    state.toggleCert = $("toggleCert").checked;

    state.sameAddress = $("sameAddress").checked;
    state.tempAddress = $("tempAddress").value.trim();
    state.permAddress = $("permAddress").value.trim();

    if(state.sameAddress){
      state.permAddress = state.tempAddress;
      $("permAddress").value = state.permAddress;
      $("permAddress").disabled = true;
    }else{
      $("permAddress").disabled = false;
    }
  }

  function writeStateToForm(){
    $("template").value = state.template || "t05";
    $("theme").value = state.theme || "blue";
    $("customAccent").value = state.customAccent || "";
    $("customAccent2").value = state.customAccent2 || "";
    $("brand").value = state.brand || "DS Computer Classes";

    $("enablePage2").checked = !!state.enablePage2;

    $("atsMode").checked = !!state.atsMode;
    $("photoEnabled").checked = !!state.photoEnabled;

    $("name").value = state.name || "";
    $("fatherName").value = state.fatherName || "";
    $("role").value = state.role || "";
    $("phone").value = state.phone || "";
    $("email").value = state.email || "";
    $("links").value = state.links || "";

    $("summary").value = state.summary || "";

    $("skills").value = state.skills || "";
    $("education").value = state.education || "";
    $("experience").value = state.experience || "";
    $("projects").value = state.projects || "";
    $("certs").value = state.certs || "";
    $("langs").value = state.langs || "";
    $("hobbies").value = state.hobbies || "";

    $("toggleExp").checked = !!state.toggleExp;
    $("toggleProj").checked = !!state.toggleProj;
    $("toggleCert").checked = !!state.toggleCert;

    $("sameAddress").checked = !!state.sameAddress;
    $("tempAddress").value = state.tempAddress || "";
    $("permAddress").value = state.permAddress || "";

    if(state.sameAddress){
      $("permAddress").disabled = true;
      $("permAddress").value = $("tempAddress").value.trim();
    }else{
      $("permAddress").disabled = false;
    }
  }

  function applyThemeVars(pageEl){
    let a = "#2563eb", b = "#7c3aed";
    if(state.theme !== "custom"){
      const t = THEMES[state.theme] || THEMES.blue;
      a = t.a; b = t.b;
    }else{
      if(state.customAccent) a = state.customAccent;
      if(state.customAccent2) b = state.customAccent2;
    }
    pageEl.style.setProperty("--accent", a);
    pageEl.style.setProperty("--accent2", b);
  }

  function sectionHTML(title, inner, tpl){
    if(tpl.style === "cv"){
      return `
        <div class="r-sec block">
          <div class="secbar">${escapeHtml(title.toUpperCase())}:</div>
          <div style="padding:8px 4px 0">${inner}</div>
        </div>
      `;
    }
    return `<div class="r-sec block">
      <h3>${escapeHtml(title)}</h3>
      ${inner}
    </div>`;
  }

  function listLinesAsItems(text){
    const ls = lines(text);
    if(!ls.length) return `<p>â€”</p>`;
    return ls.map(x=>`<div class="r-item"><div class="head"><strong>${escapeHtml(x)}</strong></div></div>`).join("");
  }

  function blockItemsHTML(text){
    const items = parseBlockToItems(text);
    if(!items.length) return `<p>â€”</p>`;
    return items.map(it=>{
      const head = escapeHtml(it.head);
      const desc = it.descLines.length ? `<p>${escapeHtml(it.descLines.join(" "))}</p>` : "";
      const bullets = it.bullets.length ? `<ul class="r-ul">${it.bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}</ul>` : "";
      return `<div class="r-item block-item">
        <div class="head"><strong>${head}</strong></div>
        ${desc}
        ${bullets}
      </div>`;
    }).join("");
  }

  function skillsChips(text){
    const arr = splitComma(text);
    if(!arr.length) return `<span class="r-skill">â€”</span>`;
    return arr.map(x=>`<span class="r-skill">${escapeHtml(x)}</span>`).join("");
  }

  function buildHeader(tpl){
    const useIcons = !state.atsMode;

    const meta = [];
    if(state.phone) meta.push((useIcons ? "ðŸ“ž " : "") + escapeHtml(state.phone));
    if(state.email) meta.push((useIcons ? "âœ‰ï¸ " : "") + escapeHtml(state.email));
    splitComma(state.links).forEach(l => meta.push((useIcons ? "ðŸ”— " : "") + escapeHtml(l)));

    const showPhoto = (!state.atsMode) && state.photoEnabled && !!state.photoDataUrl;
    const photoHTML = showPhoto
      ? `<div class="avatar"><img src="${state.photoDataUrl}" alt="photo"></div>`
      : ((!state.atsMode && state.photoEnabled)
        ? `<div class="avatar" style="display:grid;place-items:center;color:#9ca3af;font-weight:800">PHOTO</div>`
        : "");

    const cls = `hdr ${tpl.header}`;
    return `
      <div class="${cls}">
        <div class="hdr-row">
          ${photoHTML}
          <div style="flex:1">
            <p class="r-name">${escapeHtml(state.name || "Your Name")}</p>
            <div class="r-role">${escapeHtml(state.role || "Your Title")}</div>
            <div class="r-meta">
              ${meta.map(m=>`<span class="r-chip">${m}</span>`).join("")}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function buildPersonalDetails(tpl){
    const rows = [];
    if(state.fatherName){
      rows.push(`<div class="r-item"><div class="head"><strong>Father's Name</strong></div><p>${escapeHtml(state.fatherName)}</p></div>`);
    }
    if(state.tempAddress){
      rows.push(`<div class="r-item"><div class="head"><strong>Temporary Address</strong></div><p>${escapeHtml(state.tempAddress)}</p></div>`);
    }
    const perm = state.sameAddress ? state.tempAddress : state.permAddress;
    if(perm){
      rows.push(`<div class="r-item"><div class="head"><strong>Permanent Address</strong></div><p>${escapeHtml(perm)}</p></div>`);
    }
    if(!rows.length) return "";
    return sectionHTML("Personal Details", rows.join(""), tpl);
  }

  function buildBodyHTML(tpl){
    const objective = sectionHTML("Career Objective", `<p>${escapeHtml(state.summary || "Write a short objective here.")}</p>`, tpl);
    const education = sectionHTML("Academic Qualifications", listLinesAsItems(state.education), tpl);

    const experience = state.toggleExp ? sectionHTML("Experience", blockItemsHTML(state.experience), tpl) : "";
    const projects = state.toggleProj ? sectionHTML("Projects", blockItemsHTML(state.projects), tpl) : "";
    const certs = state.toggleCert ? sectionHTML("Certifications", listLinesAsItems(state.certs), tpl) : "";

    const skills = sectionHTML("Key Skills", (tpl.style==="cv")
      ? `<ul class="r-ul">${splitComma(state.skills).map(s=>`<li>${escapeHtml(s)}</li>`).join("") || "<li>â€”</li>"}</ul>`
      : `<div class="r-skillwrap">${skillsChips(state.skills)}</div>`, tpl);

    const langs = sectionHTML("Languages Known", (tpl.style==="cv")
      ? `<ul class="r-ul">${splitComma(state.langs).map(s=>`<li>${escapeHtml(s)}</li>`).join("") || "<li>â€”</li>"}</ul>`
      : `<div class="r-skillwrap">${skillsChips(state.langs)}</div>`, tpl);

    const hobbies = sectionHTML("Hobbies & Interests", (tpl.style==="cv")
      ? `<ul class="r-ul">${splitComma(state.hobbies).map(s=>`<li>${escapeHtml(s)}</li>`).join("") || "<li>â€”</li>"}</ul>`
      : `<div class="r-skillwrap">${skillsChips(state.hobbies)}</div>`, tpl);

    const personal = buildPersonalDetails(tpl);

    const wrapClass = tpl.style === "cv" ? "cv" : "modern";
    return `
      <div class="${wrapClass}">
        ${objective}
        ${education}
        ${experience}
        ${projects}
        ${certs}
        ${skills}
        ${langs}
        ${hobbies}
        ${personal}
      </div>
    `;
  }

  function pageShell(pageNo, tpl){
    return `
      <div class="page" data-page="${pageNo}" data-deco="${escapeHtml(tpl.deco)}">
        <div class="inner"><div class="content"></div></div>
        <div class="watermark">${escapeHtml(state.brand || "")}</div>
      </div>
    `;
  }

  function getEffectiveTemplate(){
    if(state.atsMode){
      return {name:"ATS",header:"classic",deco:"none",style:"modern"};
    }
    return TEMPLATES[state.template] || TEMPLATES.t01;
  }

  /* Auto split to page2 (no cut) */
  function renderPages(){
    const tpl = getEffectiveTemplate();
    const pagesEl = $("pages");
    pagesEl.innerHTML = pageShell(1, tpl) + pageShell(2, tpl);

    const p1 = pagesEl.querySelector('[data-page="1"]');
    const p2 = pagesEl.querySelector('[data-page="2"]');
    applyThemeVars(p1); applyThemeVars(p2);

    const p1Content = p1.querySelector(".content");
    const p2Content = p2.querySelector(".content");
    p1Content.innerHTML = ""; p2Content.innerHTML = "";

    if(tpl.style === "cv" && !state.atsMode){
      p1Content.insertAdjacentHTML("beforeend", `<div class="cv-titlebar">CURRICULUM VITAE</div>`);
      p2Content.insertAdjacentHTML("beforeend", `<div class="cv-titlebar">CURRICULUM VITAE</div>`);
    }

    const headerHTML = buildHeader(tpl);
    p1Content.insertAdjacentHTML("beforeend", headerHTML);
    p2Content.insertAdjacentHTML("beforeend", headerHTML);

    const p1Body = document.createElement("div");
    const p2Body = document.createElement("div");
    p1Content.appendChild(p1Body);
    p2Content.appendChild(p2Body);

    const tmp = document.createElement("div");
    tmp.innerHTML = buildBodyHTML(tpl);

    // mark all sections as blocks to split safely
    tmp.querySelectorAll(".r-sec").forEach(el=>el.classList.add("block"));

    const blocks = Array.from(tmp.querySelectorAll(".block"));
    const p1Inner = p1.querySelector(".inner");
    const p2Inner = p2.querySelector(".inner");

    const overflow = (inner)=> inner.scrollHeight > inner.clientHeight + 1;

    // Try place block in p1 else move to p2
    let needsP2 = false;
    for(const b of blocks){
      const clone = b.cloneNode(true);
      p1Body.appendChild(clone);
      if(overflow(p1Inner)){
        p1Body.removeChild(clone);
        needsP2 = true;
        p2Body.appendChild(b.cloneNode(true));
      }
    }

    if(needsP2 && !state.enablePage2){
      state.enablePage2 = true;
      $("enablePage2").checked = true;
      saveLocal();
    }

    const showP2 = state.enablePage2 && p2Body.children.length>0;
    p2.style.display = showP2 ? "" : "none";
  }

  function renderAll(){ renderPages(); }

  function applyObjective(idxStr){
    if(idxStr==="" || idxStr==null) return;
    const idx = Number(idxStr);
    if(Number.isNaN(idx)) return;
    const val = OBJECTIVES[idx] || "";
    if(!val) return;
    const current = $("summary").value.trim();
    if(!current || confirm("Replace the current Objective text?")){
      $("summary").value = val;
      readFormToState();
      renderAll();
      saveLocal();
    }
  }

  function hookEvents(){
    const ids = [
      "template","theme","customAccent","customAccent2","brand","enablePage2",
      "atsMode","photoEnabled",
      "name","fatherName","role","phone","email","links",
      "summary","skills","education","experience","projects","certs","langs","hobbies",
      "toggleExp","toggleProj","toggleCert",
      "sameAddress","tempAddress","permAddress"
    ];

    ids.forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener("input", ()=>{ readFormToState(); renderAll(); saveLocal(); });
      el.addEventListener("change", ()=>{ readFormToState(); renderAll(); saveLocal(); });
    });

    $("objectiveTpl").addEventListener("change", ()=>applyObjective($("objectiveTpl").value));

    $("photo").addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        state.photoDataUrl = reader.result;
        renderAll(); saveLocal();
      };
      reader.readAsDataURL(file);
    });

    $("sameAddress").addEventListener("change", ()=>{
      readFormToState();
      if(state.sameAddress){
        $("permAddress").value = $("tempAddress").value.trim();
        $("permAddress").disabled = true;
      }else{
        $("permAddress").disabled = false;
      }
      renderAll(); saveLocal();
    });

    $("tempAddress").addEventListener("input", ()=>{
      if($("sameAddress").checked){
        $("permAddress").value = $("tempAddress").value.trim();
      }
    });

    $("btnSave").addEventListener("click", ()=>{ readFormToState(); saveLocal(); alert("Saved âœ…"); });

    $("btnLoad").addEventListener("click", ()=>{
      const ok = loadLocal();
      if(!ok) return alert("No saved data found.");
      writeStateToForm();
      renderAll();
      alert("Loaded âœ…");
    });

    $("btnReset").addEventListener("click", ()=>{
      if(!confirm("Reset all fields?")) return;
      const keepBrand = state.brand || "DS Computer Classes";
      Object.keys(state).forEach(k=>{
        if(typeof state[k]==="boolean") state[k]=false;
        else state[k]="";
      });
      state.template="t05";
      state.theme="blue";
      state.brand=keepBrand;
      state.enablePage2=true;
      state.toggleExp=true; state.toggleProj=true; state.toggleCert=true;
      state.photoEnabled=true;
      state.atsMode=false;
      state.sameAddress=false;
      writeStateToForm();
      renderAll();
      saveLocal();
    });

    $("btnPrint").addEventListener("click", ()=>window.print());

    $("btnPDF").addEventListener("click", async ()=>{
      try{
        readFormToState();
        renderAll();

        const { jsPDF } = window.jspdf;
        const pages = Array.from(document.querySelectorAll(".page")).filter(p => p.style.display !== "none");

        document.body.classList.add("pdf-mode");

        const pdf = new jsPDF({ unit:"mm", format:"a4", orientation:"portrait" });

        for(let i=0; i<pages.length; i++){
          const pageEl = pages[i];

          const canvas = await html2canvas(pageEl, {
            scale: 3,
            useCORS: true,
            backgroundColor: "#ffffff",
            scrollX: 0,
            scrollY: 0
          });

          const imgData = canvas.toDataURL("image/jpeg", 0.98);
          if(i>0) pdf.addPage();
          pdf.addImage(imgData, "JPEG", 0, 0, 210, 297);
        }

        const filename = (state.name ? state.name.replace(/\s+/g,"_") : "resume") + "_DS.pdf";

        // Try save
        pdf.save(filename);

        document.body.classList.remove("pdf-mode");
      }catch(err){
        document.body.classList.remove("pdf-mode");
        console.error(err);
        alert("PDF download blocked/failed. Try Chrome/Edge and allow downloads. If still issue, use Print -> Save as PDF.");
      }
    });
  }

  async function main(){
    setSelectOptions();
    loadLocal();
    writeStateToForm();
    hookEvents();
    renderAll();
    saveLocal();
  }

  main();
})();
</script>
</body>
</html>
